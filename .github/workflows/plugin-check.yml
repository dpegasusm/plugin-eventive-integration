name: 'plugin-check'
on: # rebuild any PRs and main branch changes
  pull_request:
  push:
    branches:
    - main
    - 'releases/*'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Create build folder (repo name without plugin-)
      shell: bash
      run: |
        set -euo pipefail

        # repo is like "owner/plugin-my-cool-thing"
        REPO_NAME="${GITHUB_REPOSITORY#*/}"             # => plugin-my-cool-thing
        BUILD_NAME="${REPO_NAME#plugin-}"               # => my-cool-thing (unchanged if no prefix)
        echo "BUILD_NAME=$BUILD_NAME" >> "$GITHUB_ENV"

        rm -rf "build/$BUILD_NAME"
        mkdir -p "build/$BUILD_NAME"

        # Copy everything into build folder, excluding repo/CI-only stuff
        rsync -a --delete \
          --exclude=".git/" \
          --exclude=".github/" \
          --exclude=".gitignore" \
          --exclude="node_modules/" \
          --exclude="vendor/" \
          ./ "build/$BUILD_NAME/"
            
    - name: Run plugin check
      uses: wordpress/plugin-check-action@v1
      with:
        build-dir: build/${{ env.BUILD_NAME }}
        ignore-codes: |
          plugin_header_no_license
          plugin_header_invalid_license
          no_license
          no_stable_tag
          invalid_license
          missing_readme_header_tested
