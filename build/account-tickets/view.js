(()=>{"use strict";const e=window.wp.element,t=window.ReactJSXRuntime;function n(...e){for(let t=0;t<e.length;t++){const n=e[t];if(null!=n&&""!==n)return n}return""}function i(e){const t=e.event||e.screening||e.showing||{};return n(e.name,t.name,t.title,"Ticket")}function s(e){const t=e.event||e.screening||e.showing||{},i=n(t.start_time,t.begins_at,t.starts_at,e.starts_at),s=n(t.venue&&t.venue.name,t.venue_name,e.venue_name),c=[];return i&&c.push(function(e){try{const t=new Date(e);return!e||isNaN(t)?"":t.toLocaleString([],{dateStyle:"medium",timeStyle:"short"})}catch(t){return e||""}}(i)),s&&c.push(s),c.join(" • ")}function c(e){const t=e.event||e.screening||e.showing||{};return!!n(e.is_virtual,t.is_virtual,t.virtual)}function a(e){const t=e.event||e.screening||e.showing||{},i=n(t.start_time,t.begins_at,t.starts_at,e.starts_at),s=Date.parse(i||"");return isNaN(s)?null:s}function o(e){const t=a(e);return null!==t&&t<Date.now()}function r(e){const t=n(e.scanned_at,e.scan&&e.scan.scanned_at);if(!t)return"";try{return new Date(t).toLocaleString([],{dateStyle:"medium",timeStyle:"short"})}catch(e){return String(t)}}function l({bucket:l}){const[d,u]=(0,e.useState)(!1),[v,h]=(0,e.useState)(!0),[p,x]=(0,e.useState)([]),[g,m]=(0,e.useState)("all"),[f,b]=(0,e.useState)(!1),[y,j]=(0,e.useState)(null);(0,e.useEffect)(()=>{const e=()=>{if(window.Eventive&&window.Eventive.isLoggedIn)try{const e=window.Eventive.isLoggedIn();u(e),e&&k()}catch(e){console.error("Error checking login:",e)}finally{h(!1)}else setTimeout(e,100)};window.Eventive&&window.Eventive.on?window.Eventive.on("ready",e):e()},[]);const k=()=>{const e={};if(l)try{e.conditions=JSON.stringify({event_bucket:l})}catch(e){}window.Eventive.request({method:"GET",path:"people/self/tickets",qs:e,authenticatePerson:!0}).then(e=>{const t=e&&(e.tickets||e)||[];x(t)}).catch(()=>{window.Eventive.request({method:"GET",path:"people/self/tickets_including_global",qs:e,authenticatePerson:!0}).then(e=>{const t=e&&(e.tickets||e)||[];x(t)}).catch(e=>{console.error("[eventive-account-tickets] Error fetching tickets:",e)})})},w=()=>{b(!1),j(null)};(0,e.useEffect)(()=>{const e=e=>{"Escape"===e.key&&w()};return f&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow=""}},[f]),(0,e.useEffect)(()=>{p.length>0&&setTimeout(()=>{if(window.Eventive&&window.Eventive.rebuild)try{window.Eventive.rebuild()}catch(e){}},100)},[p,g]);const _=(e,a)=>{const l=i(e),d=s(e),u=function(e){const t=n(e.seat_label,e.seat,e.seat&&e.seat.name),i=n(e.row_label,e.row),s=n(e.section_label,e.section),c=[];return s&&c.push("Sec "+s),i&&c.push("Row "+i),t&&c.push("Seat "+t),c.join(" · ")}(e),v=c(e),h=o(e),p=r(e),x=function(e){if(!c(e))return!1;const t=function(e){const t=e.event||e.screening||e.showing||{},i=n(e.unlocked_until,e.virtual_unlocked_until,t.unlocked_until,t.virtual_unlocked_until),s=Date.parse(i||"");return isNaN(s)?null:s}(e);return null!==t&&t<Date.now()}(e),g=(m=e).event&&m.event.id?m.event.id:"";var m;return(0,t.jsxs)("div",{className:"eventive-ticket-card",children:[(0,t.jsxs)("div",{className:"eventive-ticket-card__body",children:[(0,t.jsx)("div",{className:"eventive-ticket-card__title",children:l}),(0,t.jsxs)("div",{style:{marginBottom:"4px"},children:[p&&(0,t.jsxs)("span",{className:"evt-badge",style:{display:"inline-block",marginRight:"6px",padding:"2px 8px",borderRadius:"999px",background:"#dcfce7",color:"#14532d",fontWeight:700,fontSize:"0.75em"},children:["Scanned ",p]}),!v&&h&&(0,t.jsx)("span",{className:"evt-badge",style:{display:"inline-block",marginRight:"6px",padding:"2px 8px",borderRadius:"999px",background:"#e5e7eb",color:"#111827",fontWeight:700,fontSize:"0.75em"},children:"Event passed"}),v&&x&&(0,t.jsx)("span",{className:"evt-badge",style:{display:"inline-block",marginRight:"6px",padding:"2px 8px",borderRadius:"999px",background:"#fee2e2",color:"#991b1b",fontWeight:700,fontSize:"0.75em"},children:"Virtual window closed"})]}),(0,t.jsx)("div",{className:"eventive-ticket-card__meta",children:d}),u&&(0,t.jsx)("div",{className:"eventive-ticket-card__seat",children:u})]}),(0,t.jsx)("div",{className:"eventive-ticket-card__actions",children:v?x?(0,t.jsx)("span",{className:"evt-badge evt-badge-expired",style:{display:"inline-block",padding:"6px 10px",borderRadius:"6px",background:"#fee2e2",color:"#991b1b",fontWeight:700},children:"Virtual window closed"}):(0,t.jsx)("div",{className:"eventive-button","data-event":g||""}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{className:"evt-btn evt-btn-secondary",onClick:()=>(e=>{j(e),b(!0)})(e),children:"Show Code"}),g&&(0,t.jsx)("div",{className:"eventive-button","data-vote-event":g,"data-vote":"true"})]})})]},a)};if(v)return(0,t.jsx)("div",{className:"eventive-login-container",style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100px"},children:(0,t.jsx)("div",{className:"loader"})});if(!d)return(0,t.jsx)("div",{className:"eventive-notice",style:{textAlign:"center"},children:"Please log in to view your tickets."});if(0===p.length)return(0,t.jsx)("div",{className:"eventive-account-tickets",children:(0,t.jsxs)("div",{className:"eventive-tickets-column",children:[(0,t.jsx)("h2",{children:"Tickets"}),(0,t.jsx)("p",{children:"No tickets found for this account."})]})});const{upcoming:N,virtuals:S,past:E}=(()=>{const e=Date.now(),t=[],n=[],i=[];return p.forEach(s=>{const o=a(s);c(s)?n.push(s):null!==o&&o>=e?t.push(s):i.push(s)}),{upcoming:t,virtuals:n,past:i}})();let R=N,C=S,T=E;return"upcoming"===g?(C=[],T=[]):"virtual"===g?(R=[],T=[]):"past"===g&&(R=[],C=[]),(0,t.jsxs)("div",{className:"eventive-account-tickets",children:[(0,t.jsxs)("div",{className:"eventive-tickets-column",children:[(0,t.jsx)("h2",{children:"Tickets"}),(0,t.jsxs)("div",{className:"eventive-ticket-filters",style:{display:"flex",alignItems:"center",gap:"8px",margin:"6px 0 12px"},children:[(0,t.jsx)("label",{htmlFor:"ticket-filter",style:{fontWeight:600},children:"Show:"}),(0,t.jsxs)("select",{id:"ticket-filter",className:"eventive-ticket-filter-select",value:g,onChange:e=>m(e.target.value),children:[(0,t.jsx)("option",{value:"all",children:"All"}),(0,t.jsx)("option",{value:"upcoming",children:"Upcoming"}),(0,t.jsx)("option",{value:"virtual",children:"Virtual"}),(0,t.jsx)("option",{value:"past",children:"Past"})]})]}),R.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"eventive-ticket-section",children:"Upcoming"}),R.map(_)]}),C.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"eventive-ticket-section",children:"Virtual"}),C.map(_)]}),T.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"eventive-ticket-section",children:"Past"}),T.map(_)]})]}),f&&y&&(0,t.jsx)("div",{className:"eventive-ticket-barcode-modal is-open",style:{display:"flex",position:"fixed",inset:0,alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.45)",zIndex:9999},onClick:e=>e.target.classList.contains("eventive-ticket-barcode-modal")&&w(),children:(0,t.jsxs)("div",{className:"barcode-modal-inner",style:{background:"#fff",maxWidth:"560px",width:"92vw",padding:"20px",borderRadius:"12px",position:"relative"},children:[(0,t.jsx)("button",{className:"modal-close-btn",onClick:w,style:{position:"absolute",right:"12px",top:"10px",fontSize:"22px",lineHeight:1,background:"none",border:"none",cursor:"pointer"},"aria-label":"Close",children:"×"}),(0,t.jsxs)("div",{className:"barcode-modal-body",children:[(0,t.jsx)("h3",{style:{margin:"0 0 10px 0",textAlign:"center"},children:i(y)}),s(y)&&(0,t.jsx)("div",{style:{textAlign:"center",opacity:.8,marginBottom:"6px"},children:s(y)}),r(y)&&(0,t.jsx)("div",{style:{textAlign:"center",margin:"6px 0 4px 0"},children:(0,t.jsxs)("span",{style:{display:"inline-block",padding:"4px 10px",borderRadius:"999px",background:"#dcfce7",color:"#14532d",fontWeight:700},children:["Scanned"," ",r(y)]})}),(()=>{const e=(s=n((i=y).qr_code_path,i.barcode_path,i.barcode&&i.barcode.path))?/^https?:\/\//i.test(s)?s:"https://api.eventive.org"+("/"===s.charAt(0)?"":"/")+s:s;var i,s;const c=o(y);return e?(0,t.jsxs)("div",{style:{position:"relative",display:"flex",justifyContent:"center",marginTop:"6px"},children:[(0,t.jsx)("img",{src:e,alt:"Ticket QR",style:{maxWidth:"320px",width:"100%",height:"auto",border:"1px solid #eee",borderRadius:"8px",padding:"12px"}}),c&&(0,t.jsx)("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.55)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",borderRadius:"8px"},children:(0,t.jsxs)("div",{style:{fontWeight:800,letterSpacing:"0.3px"},children:[(0,t.jsx)("div",{style:{fontSize:"18px"},children:"This event has passed"}),(0,t.jsx)("div",{style:{fontSize:"12px",opacity:.9},children:"Barcode disabled"})]})})]}):(0,t.jsx)("p",{children:"No barcode available."})})()]})]})})]})}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".wp-block-eventive-account-tickets").forEach(n=>{(0,e.createRoot)(n).render((0,t.jsx)(l,{}))})})})();