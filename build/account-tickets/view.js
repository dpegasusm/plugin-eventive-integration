(()=>{"use strict";const e=window.wp.element,t=window.ReactJSXRuntime;function n(...e){for(let t=0;t<e.length;t++){const n=e[t];if(null!=n&&""!==n)return n}return""}function i(e){const t=e.event||e.screening||e.showing||{};return n(e.name,t.name,t.title,"Ticket")}function s(e){const t=e.event||e.screening||e.showing||{},i=n(t.start_time,t.begins_at,t.starts_at,e.starts_at),s=n(t.venue&&t.venue.name,t.venue_name,e.venue_name),a=[];return i&&a.push(function(e){try{const t=new Date(e);return!e||isNaN(t)?"":t.toLocaleString([],{dateStyle:"medium",timeStyle:"short"})}catch(t){return e||""}}(i)),s&&a.push(s),a.join(" • ")}function a(e){const t=e.event||e.screening||e.showing||{};return!!n(e.is_virtual,t.is_virtual,t.virtual)}function c(e){const t=e.event||e.screening||e.showing||{},i=n(t.start_time,t.begins_at,t.starts_at,e.starts_at),s=Date.parse(i||"");return isNaN(s)?null:s}function r(e){const t=c(e);return null!==t&&t<Date.now()}function l(e){const t=n(e.scanned_at,e.scan&&e.scan.scanned_at);if(!t)return"";try{return new Date(t).toLocaleString([],{dateStyle:"medium",timeStyle:"short"})}catch(e){return String(t)}}function o({bucket:o}){const[d,v]=(0,e.useState)(!1),[u,h]=(0,e.useState)(!0),[m,g]=(0,e.useState)([]),[w,p]=(0,e.useState)("all"),[j,x]=(0,e.useState)(!1),[f,b]=(0,e.useState)(null),N=(0,e.useRef)(!1);(0,e.useEffect)(()=>{let e=!1,t=0;const n=()=>{if(!e){if(!window.Eventive||!window.Eventive.isLoggedIn)return t++,void(t<60?setTimeout(n,100):h(!1));try{const t=window.Eventive.isLoggedIn();v(t),t&&!N.current&&(N.current=!0,k(e))}catch(e){}finally{h(!1)}}};return window.Eventive&&window.Eventive.on&&window.Eventive.on("ready",n),n(),()=>{e=!0,window.Eventive&&window.Eventive.off&&window.Eventive.off("ready",n)}},[]);const k=e=>{if(!window.Eventive||!window.Eventive.isLoggedIn||!window.Eventive.isLoggedIn())return v(!1),h(!1),void(N.current=!1);const t={};if(o)try{t.conditions=JSON.stringify({event_bucket:o})}catch(e){}window.Eventive.request({method:"GET",path:"people/self/tickets",qs:t,authenticatePerson:!0}).then(t=>{if(e)return;const n=t&&(t.tickets||t)||[];g(n)}).catch(n=>{if(e)return;const i=(n&&(n.message||n.error||""))+"";if(i.includes("InvalidCredentials")||i.includes("401")||i.includes("Unauthorized")||i.includes("not logged in"))return v(!1),h(!1),void(N.current=!1);window.Eventive.request({method:"GET",path:"people/self/tickets_including_global",qs:t,authenticatePerson:!0}).then(t=>{if(e)return;const n=t&&(t.tickets||t)||[];g(n)}).catch(t=>{if(e)return;const n=(t&&(t.message||t.error||""))+"";(n.includes("InvalidCredentials")||n.includes("401")||n.includes("Unauthorized")||n.includes("not logged in"))&&(v(!1),N.current=!1)})})},_=()=>{x(!1),b(null)};(0,e.useEffect)(()=>{const e=e=>{"Escape"===e.key&&_()};return j&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow=""}},[j]),(0,e.useEffect)(()=>{m.length>0&&setTimeout(()=>{if(window.Eventive&&window.Eventive.rebuild)try{window.Eventive.rebuild()}catch(e){}},100)},[m,w]);const y=(e,c)=>{const o=i(e),d=s(e),v=function(e){const t=n(e.seat_label,e.seat,e.seat&&e.seat.name),i=n(e.row_label,e.row),s=n(e.section_label,e.section),a=[];return s&&a.push("Sec "+s),i&&a.push("Row "+i),t&&a.push("Seat "+t),a.join(" · ")}(e),u=a(e),h=r(e),m=l(e),g=function(e){if(!a(e))return!1;const t=function(e){const t=e.event||e.screening||e.showing||{},i=n(e.unlocked_until,e.virtual_unlocked_until,t.unlocked_until,t.virtual_unlocked_until),s=Date.parse(i||"");return isNaN(s)?null:s}(e);return null!==t&&t<Date.now()}(e),w=(p=e).event&&p.event.id?p.event.id:"";var p;return(0,t.jsxs)("div",{className:"eventive-ticket-card",children:[(0,t.jsxs)("div",{className:"eventive-ticket-card__body",children:[(0,t.jsx)("div",{className:"eventive-ticket-card__title",children:o}),(0,t.jsxs)("div",{children:[m&&(0,t.jsxs)("span",{className:"evt-badge evt-badge-scanned",children:["Scanned ",m]}),!u&&h&&(0,t.jsx)("span",{className:"evt-badge evt-badge-past",children:"Event passed"}),u&&g&&(0,t.jsx)("span",{className:"evt-badge evt-badge-expired",children:"Virtual window closed"})]}),(0,t.jsx)("div",{className:"eventive-ticket-card__meta",children:d}),v&&(0,t.jsx)("div",{className:"eventive-ticket-card__seat",children:v})]}),(0,t.jsx)("div",{className:"eventive-ticket-card__actions",children:u?g?(0,t.jsx)("span",{className:"evt-badge evt-badge-expired",children:"Virtual window closed"}):(0,t.jsx)("div",{className:"eventive-button","data-event":w||""}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{className:"evt-btn evt-btn-secondary",onClick:()=>(e=>{b(e),x(!0)})(e),children:"Show Code"}),w&&(0,t.jsx)("div",{className:"eventive-button","data-vote-event":w,"data-vote":"true"})]})})]},c)};if(u)return(0,t.jsx)("div",{className:"eventive-login-container",children:(0,t.jsx)("div",{className:"loader"})});if(!d)return(0,t.jsx)("div",{className:"eventive-notice",children:"Please log in to view your tickets."});if(0===m.length)return(0,t.jsx)("div",{className:"eventive-account-tickets",children:(0,t.jsxs)("div",{className:"eventive-tickets-column",children:[(0,t.jsx)("h2",{children:"Tickets"}),(0,t.jsx)("p",{children:"No tickets found for this account."})]})});const{upcoming:E,virtuals:S,past:L}=(()=>{const e=Date.now(),t=[],n=[],i=[];return m.forEach(s=>{const r=c(s);a(s)?n.push(s):null!==r&&r>=e?t.push(s):i.push(s)}),{upcoming:t,virtuals:n,past:i}})();let C=E,T=S,D=L;return"upcoming"===w?(T=[],D=[]):"virtual"===w?(C=[],D=[]):"past"===w&&(C=[],T=[]),(0,t.jsxs)("div",{className:"eventive-account-tickets",children:[(0,t.jsxs)("div",{className:"eventive-tickets-column",children:[(0,t.jsx)("h2",{children:"Tickets"}),(0,t.jsxs)("div",{className:"eventive-ticket-filters",children:[(0,t.jsx)("label",{htmlFor:"ticket-filter",children:"Show:"}),(0,t.jsxs)("select",{id:"ticket-filter",className:"eventive-ticket-filter-select",value:w,onChange:e=>p(e.target.value),children:[(0,t.jsx)("option",{value:"all",children:"All"}),(0,t.jsx)("option",{value:"upcoming",children:"Upcoming"}),(0,t.jsx)("option",{value:"virtual",children:"Virtual"}),(0,t.jsx)("option",{value:"past",children:"Past"})]})]}),C.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"eventive-ticket-section",children:"Upcoming"}),C.map(y)]}),T.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"eventive-ticket-section",children:"Virtual"}),T.map(y)]}),D.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"eventive-ticket-section",children:"Past"}),D.map(y)]})]}),j&&f&&(0,t.jsx)("div",{className:"eventive-modal-overlay eventive-modal-overlay--dark",onClick:e=>e.target.classList.contains("eventive-modal-overlay")&&_(),children:(0,t.jsxs)("div",{className:"eventive-modal-panel eventive-modal-panel--small barcode-modal-inner",children:[(0,t.jsx)("button",{className:"eventive-modal-close-btn",onClick:_,"aria-label":"Close",children:"×"}),(0,t.jsxs)("div",{className:"barcode-modal-body",children:[(0,t.jsx)("h3",{children:i(f)}),s(f)&&(0,t.jsx)("div",{className:"barcode-meta",children:s(f)}),l(f)&&(0,t.jsx)("div",{className:"barcode-scanned-badge",children:(0,t.jsxs)("span",{children:["Scanned"," ",l(f)]})}),(()=>{const e=(s=n((i=f).qr_code_path,i.barcode_path,i.barcode&&i.barcode.path))?/^https?:\/\//i.test(s)?s:"https://api.eventive.org"+("/"===s.charAt(0)?"":"/")+s:s;var i,s;const a=r(f);return e?(0,t.jsxs)("div",{className:"barcode-qr-container",children:[(0,t.jsx)("img",{src:e,alt:"Ticket QR"}),a&&(0,t.jsx)("div",{className:"past-event-overlay",children:(0,t.jsxs)("div",{className:"overlay-content",children:[(0,t.jsx)("div",{className:"overlay-title",children:"This event has passed"}),(0,t.jsx)("div",{className:"overlay-subtitle",children:"Barcode disabled"})]})})]}):(0,t.jsx)("p",{children:"No barcode available."})})()]})]})})]})}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".wp-block-eventive-account-tickets").forEach(n=>{(0,e.createRoot)(n).render((0,t.jsx)(o,{}))})})})();