(()=>{"use strict";function e(e){return(e<10?"0":"")+e}function t(t){return t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())}function n(e){const t=new Date(e),n=t.getDay(),i=(0===n?-6:1)-n;return t.setDate(t.getDate()+i),t.setHours(0,0,0,0),t}function i(e){const t=n(e),i=new Date(t);return i.setDate(i.getDate()+6),i.setHours(23,59,59,999),i}function a(e,t){const n=new Date(e);return n.setDate(n.getDate()+t),n}function r(e){return e.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"})}function s(e){const t=new Date(e);return t.setHours(0,0,0,0),t}function o(e,t){return+e<+t}window.wp.element,document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".wp-block-eventive-native-year-round").forEach(e=>{if(e.__inited)return;e.__inited=!0,window.EventiveBlockData,window.EventiveBlockData;const c=window.EventiveBlockData?.eventBucket||window.eventiveOptions?.eventBucket||"",l=e.getAttribute("data-image")||"poster",d="true"===e.getAttribute("data-description"),v="true"===e.getAttribute("data-venue"),m="true"===e.getAttribute("data-details"),u=window.eventiveOptions?.filmDetailBaseURL||"",p=window.eventiveOptions?.usePrettyPermalinks||!1,y=window.eventiveOptions?.filmSyncEnabled||!1,_=new Date,f=s(_),w=n(_);let g=n(_),h=i(_),b=new Date(Math.max(+g,+f));const D={};let E={},$=!1;const L=document.createElement("div");L.className="eventive-nyr-calendar-wrap";const k=document.createElement("div");k.className="eventive-nyr-nav",k.innerHTML='\n\t\t\t<button class="eventive-nyr-btn eventive-nyr-prev" type="button">‹ Prev</button>\n\t\t\t<div class="eventive-nyr-buttons"></div>\n\t\t\t<button class="eventive-nyr-btn eventive-nyr-next" type="button">Next ›</button>\n\t\t',L.appendChild(k);const N=document.createElement("div");N.className="eventive-nyr-events",L.appendChild(N),e.appendChild(L);const S=k.querySelector(".eventive-nyr-prev"),C=k.querySelector(".eventive-nyr-next"),x=k.querySelector(".eventive-nyr-buttons"),T=()=>{$||($=!0,requestAnimationFrame(()=>{$=!1,A()}))},M=()=>{let e="";for(let n=0;n<7;n++){const i=a(g,n),c=t(i),l=c===t(b),d=o(s(i),f);e+=`<button class="yr-day-btn ${l?"is-active":""} ${d?"is-disabled":""}" data-day="${c}" type="button" ${d?"disabled":""}>${r(i)}</button>`}x.innerHTML=e,x.querySelectorAll(".yr-day-btn").forEach(e=>{e.addEventListener("click",()=>{if(e.hasAttribute("disabled"))return;const t=e.getAttribute("data-day");b=new Date(t+"T12:00:00"),M(),T()})})},A=()=>{const e=t(b),n=E&&E[e]||[];if(!n.length)return void(N.innerHTML='<div class="yr-no-events">No events this day.</div>');const i={};n.forEach(e=>{const t=e.venue&&e.venue.id||(e.is_virtual?"virtual":"unknown"),n=e.films&&e.films[0]||e.film||null,a=n&&n.id||"",r=e.name||e.title||n&&(n.name||n.title)||"Untitled",s=t+"::"+(a||r);i[s]||(i[s]={evRef:e,film:n||{},title:r,venueName:e.venue&&(e.venue.name||e.venue.display_name||e.venue.slug)||(e.is_virtual?"Virtual":"TBA"),items:[]}),i[s].items.push({id:e.id,dt:new Date(e.start_time),ev:e})});const a=Object.values(i);a.forEach(e=>{e.items.sort((e,t)=>+e.dt-+t.dt)}),a.sort((e,t)=>+e.items[0].dt-+t.items[0].dt),N.innerHTML="",a.forEach(e=>{const t=e.evRef,n=t.film||t.films&&t.films[0]||{},i=e.title;let a="";var r;"none"!==l&&(a=function(e,t){return e?"cover"===t?e.cover_image||e.still_image||e.poster_image||"":"still"===t?e.still_image||e.poster_image||e.cover_image||"":"none"===t?"":e.poster_image||e.cover_image||e.still_image||"":""}(n,l)||(r=t)&&(r.image||r.poster_image||r.cover_image||r.still_image||r.film_poster_image||r.film_cover_image)||""||"");const s=d&&(t.short_description||t.description||n.short_description||n.description)||"",o=m?(e=>{const t=e&&e.film;if(!t)return"#";if(y){const e=t.slug||String(t.name||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return(u||"").replace(/\/$/,"")+"/"+e}return p?u+"?film-id="+encodeURIComponent(t.id||""):u+"&film-id="+encodeURIComponent(t.id||"")})(t):"#",c=document.createElement("article");if(c.className="yr-card yr-card--stack"+(a?" has-media":""),a){const e=document.createElement("div");e.className="yr-card__media",e.innerHTML=`<img loading="lazy" decoding="async" alt="${i}" src="${a}" />`,c.appendChild(e)}const _=document.createElement("div");_.className="yr-card__body",_.innerHTML=`\n\t\t\t\t\t<h3 class="yr-card__title">${i}</h3>\n\t\t\t\t\t${v?`<div class="yr-card__meta">${e.venueName}</div>`:""}\n\t\t\t\t\t${s?`<div class="yr-card__desc">${s}</div>`:""}\n\t\t\t\t\t${m?`<div class="yr-card__links"><a class="yr-more" href="${o}">Details</a></div>`:""}\n\t\t\t\t`,c.appendChild(_);const f=document.createElement("div");f.className="yr-card__cta";const w=document.createElement("div");w.className="yr-card__showtimes yr-showtimes-flex",w.style.display="flex",w.style.flexWrap="wrap",w.style.gap="8px 12px",w.style.alignItems="stretch",e.items.forEach(e=>{const t=document.createElement("div");var n;t.className="yr-showtime__btn",t.style.flex="0 1 240px",t.innerHTML=`<div class="eventive-button" data-event="${e.id}" data-label="${n=e.dt,n.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit"})}"></div>`,w.appendChild(t)}),f.appendChild(w),c.appendChild(f),N.appendChild(c)}),window.Eventive?.rebuild&&setTimeout(()=>{window.Eventive.rebuild()},60)},H=async()=>{const e=g,n=h,i=t(e);if(D[i])E=D[i];else try{const a=new URLSearchParams;a.append("start_time_gte",new Date(e).toISOString()),a.append("start_time_lte",new Date(n).toISOString()),a.append("include_past_events","true"),a.append("include","film,films,program_item");let r=`event_buckets/${c}/events?${a.toString()}`;const o=await window.Eventive.request({method:"GET",path:r,authenticatePerson:!1});let l=o&&(o.events||o)||[];l=l.filter(t=>{if(!t||!t.start_time)return!1;const i=new Date(t.start_time);return!isNaN(i)&&i>=e&&i<=n});const d={};t(g)===t(w)&&(l=l.filter(e=>+s(new Date(e.start_time))>=+f)),l.sort((e,t)=>new Date(e.start_time)-new Date(t.start_time)),l.forEach(e=>{!e.film&&e.films&&e.films[0]&&(e.film=e.films[0]);const n=t(new Date(e.start_time));(d[n]||(d[n]=[])).push(e)}),E=d,D[i]=d}catch(e){console.error("[eventive-native-year-round] Error fetching week events:",e),E={}}},O=()=>{const e=!o(w,g);S.disabled=e,e?S.classList.add("is-disabled"):S.classList.remove("is-disabled")},q=async e=>{let n=a(g,7*e);o(n,w)&&(n=w),g=n,h=i(g),b=new Date(Math.max(+g,+f)),M();const r=t(g);D[r]?(E=D[r],T()):(await H(),T()),O()};S.addEventListener("click",()=>q(-1)),C.addEventListener("click",()=>q(1)),(async()=>{M(),O(),await H(),T()})()})})})();